## 컨테이너 sheel 환경으로 접근하기

docker 컨테이너의 sh 환경에 접근하기 위해서는 다음과 같은 방법을 사용.

 * docker attach
   > docker attach + container ID

   이 방식은 해당 컨테이너의 root 프로셋스에 콘솔 접근을 시켜준다.

   Ctrl + p + q 세가지 키 조합으로 빠져(detach)나올 수 있다.

 * docker exec
   > docker exec -it + Container ID + /bin/bash

 * ssh


## 도커 명령어

```bash
# 컨테이너 실행
$> docker run -d --name web -p 8080:80 nginx:latest

# 컨테이너 종료시 컨테이너 자동 삭제(--rm 옵션 사용)
$> docker run -d --rm --name web -p 8080:80 nginx:latest

# 실행중인 컨테이너 중지
$> docker stop {컨테이너 ID/이름}

# 컨테이너 목록(중지된 컨테이너 포함)
$> docker container ls -a

# 실행중인 컨테이너 삭제
$> docker rm {컨테이너 ID/이름}
```

 * 도커 컨테이너의 상태
 
   ![Alt text](image.png)

 * 인터렉티브 켄테이너
   
   > docker run -it centos:7 /bin/bash
   
   이 명령은 centos:7 이미지를 이용한 컨테이너를 생성하고 컨테이너의 /bin/bash 명령을 실행한다(이미지 이름 뒤에 실행할 명령어를 지정하지 않으면 이미지를 생성할 때 지정한 명령어를 기본으로 실행).  
   -i 옵션은 --interactive와 같은 옵션으로 컨테이너의 표준입력을 연결한다.  
   -t 옵션은 -tty와 같은 옵션으로 컨테이너를 위한 가상 터미널을 할당한다.  
   즉, -it 옵션을 이용하면 해당 프로그램을 실행하고 컨테이너에 터미널로 연결한다.

## Kafka Connect 사용해 보기

 * 데모 실행

    ```bash
    $> git clone https://github.com/confluentinc/demo-scene.git && cd demo-scene
    $> cd kafka-connect-zero-to-hero
    $> docker-compose up -d
    ```

 * Wait for Kafka Connect to be started

    ```bash
    bash -c ' \
    echo -e "\n\n=============\nWaiting for Kafka Connect to start listening on localhost ⏳\n=============\n"
    while [ $(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors) -ne 200 ] ; do
      echo -e "\t" $(date) " Kafka Connect listener HTTP state: " $(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors) " (waiting for 200)"
      sleep 5
    done
    echo -e $(date) "\n\n--------------\n\o/ Kafka Connect is ready! Listener HTTP state: " $(curl -s -o /dev/null -w %{http_code} http://localhost:8083/connectors) "\n--------------\n"
    '
    ```

 * Make sure that the Elasticsearch, Debezium, and Neo4j connectors are available

    ```bash
    curl -s localhost:8083/connector-plugins|jq '.[].class'|egrep 'Neo4jSinkConnector|MySqlConnector|ElasticsearchSinkConnector'

    # Expect:
    "io.confluent.connect.elasticsearch.ElasticsearchSinkConnector"
    "io.debezium.connector.mysql.MySqlConnector"
    "streams.kafka.connect.sink.Neo4jSinkConnector"
    ```

 * Get a MySQL prompt

    ```bash
    docker exec -it mysql bash -c 'mysql -u root -pdebezium demo'
    ```

    ㅠㅠ [복잡}(https://choiseokwon.tistory.com/294하다. 모르겠다.


## Debezium Connector 설치


```property
version: '3'
services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
      - 3306:3306
    environment:
      MYSQL_ROOT_PASSWORD: admin
      MYSQL_USER: mysqluser
      MYSQL_PASSWORD: mysqlpw 
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    volumes:
      - D:/mysql/data:/var/lib/mysql

  zookeeper:
    container_name: zookeeper
    image: wurstmeister/zookeeper
    ports:
      - "2181:2181"

  kafka:
    container_name: kafka
    image: wurstmeister/kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: 127.0.0.1
      KAFKA_ADVERTISED_PORT: 9092
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
```


```bash
# 커넥터 8083 port 가 열려있는지 확인
# 필요시 설치 apt install -y net-tools
$> netstat -lnp
$> netstat -tnlp

$> curl http://localhost:8083/

#Expect
{"version":"2.7.1","commit":"61dbce85d0d41457","kafka_cluster_id":"bMLmHpkkQNCwbEDd7ZDUFw"}

# 설치된 플러그인 목록을 조회
$> curl --location --request GET 'localhost:8083/connector-plugins'
```

 * Rest API 로 connector 생성
   ```bash
   curl --location --request POST 'http://localhost:8083/connectors' \
   --header 'Content-Type: application/json' \
   --data-raw '{
     "name": "source-test-connector",
     "config": {
       "connector.class": "io.debezium.connector.mysql.MySqlConnector",
       "tasks.max": "1",
       "database.hostname": "mysql",
       "database.port": "3306",
       "database.user": "mysqluser",
       "database.password": "mysqlpw",
       "database.server.id": "184054",
       "database.server.name": "dbserver1",
       "database.allowPublicKeyRetrieval": "true",
       "database.include.list": "testdb",
       "database.history.kafka.bootstrap.servers": "kafka:9092",
       "database.history.kafka.topic": "dbhistory.testdb",
       "key.converter": "org.apache.kafka.connect.json.JsonConverter",
       "key.converter.schemas.enable": "true",
       "value.converter": "org.apache.kafka.connect.json.JsonConverter",
       "value.converter.schemas.enable": "true",
       "transforms": "unwrap,addTopicPrefix",
       "transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
       "transforms.addTopicPrefix.type":"org.apache.kafka.connect.transforms.RegexRouter",
       "transforms.addTopicPrefix.regex":"(.*)",
       "transforms.addTopicPrefix.replacement":"$1"
    }
   }'

   # 설정 설명
   connector.class는 커넥터의 Java 클래스입니다.
   tasks.max는 이 커넥터에 대해 생성되어야 할 태스크의 최대 수입니다.
   database.hostname은 DB 엔드포인트입니다

   database.server.name는 MySQL 인스턴스를 고유하게 식별하는 데 사용할 수있는 문자열입니다.
   database.include.list는 지정한 서버에서 호스팅하는 데이터베이스의 목록을 포함합니다.
   database.history.kafka.bootstrap.servers는 부트스트랩 서버 주소
   database.history.kafka.topic은 데이터베이스 스키마 변경을 추적하기 위해 Debezium에서 내부적으로 사용하는 Kafka 주제입니다.
   ```

### connector 목록/상세 정보 확인

   ```bash
   # 목록
   curl --location --request GET 'http://localhost:8083/connectors'

   # 상세정보
   curl --location --request GET 'http://localhost:8083/connectors/{connector-name}/config ' \
   --header 'Content-Type: application/json'

   curl --location --request GET 'http://localhost:8083/connectors/source-test-connector/config ' \
   --header 'Content-Type: application/json'
   ```

### connector 삭제

   ```bash
   $> curl --location --request DELETE 'http://localhost:8083/connectors/source-test-connector'


   GET /connectors – returns a list with all connectors in use
   GET /connectors/{name} – returns details about a specific connector
   POST /connectors – creates a new connector; the request body should be a JSON object containing a string name field and an object config field with the connector configuration parameters
   GET /connectors/{name}/status – returns the current status of the connector – including if it is running, failed or paused – which worker it is assigned to, error information if it has failed, and the state of all its tasks
   DELETE /connectors/{name} – deletes a connector, gracefully stopping all tasks and deleting its configuration
   GET /connector-plugins – returns a list of connector plugins installed in the Kafka Connect cluster
   ```

### Topic 목록 확인

 > kafka-topics.sh --list --bootstrap-server localhost:9092

 

